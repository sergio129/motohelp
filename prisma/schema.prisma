generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  MECHANIC
  ADMIN
}

enum ServiceStatus {
  PENDIENTE
  ACEPTADO
  EN_CAMINO
  EN_PROCESO
  FINALIZADO
  CANCELADO
}

model User {
  id        String           @id @default(cuid())
  name      String
  email     String           @unique
  password  String
  role      Role             @default(CLIENT)
  phone     String?
  documentId String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  mechanicProfile MechanicProfile?
  clientProfile   ClientProfile?
  addresses       Address[]
  serviceRequests ServiceRequest[] @relation("ClientRequests")
  assignedServices ServiceRequest[] @relation("MechanicRequests")
  passwordResetTokens PasswordResetToken[]
}

model MechanicProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  verified        Boolean  @default(false)
  experienceYears Int
  specialty       String
  documentUrl     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  services MechanicService[]
}

model ClientProfile {
  id        String  @id @default(cuid())
  userId    String  @unique
  motoBrand String?
  motoModel String?
  motoYear  Int?
  motoPlate String?
  motoColor String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  label      String?
  street     String
  city       String
  state      String
  postalCode String
  country    String
  reference  String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model ServiceRequest {
  id          String        @id @default(cuid())
  clientId    String
  mechanicId  String?
  serviceTypeId String?
  description String
  address     String
  scheduledAt DateTime
  status      ServiceStatus @default(PENDIENTE)
  price       Decimal?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  client      User        @relation("ClientRequests", fields: [clientId], references: [id])
  mechanic    User?       @relation("MechanicRequests", fields: [mechanicId], references: [id])
  serviceType ServiceType? @relation(fields: [serviceTypeId], references: [id])
  review      Review?
  statusHistory StatusHistory[]
}

model ServiceType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  basePrice   Decimal?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requests ServiceRequest[]
  mechanics MechanicService[]
}

model MechanicService {
  id               String   @id @default(cuid())
  mechanicProfileId String
  serviceTypeId    String
  createdAt        DateTime @default(now())

  mechanicProfile MechanicProfile @relation(fields: [mechanicProfileId], references: [id])
  serviceType     ServiceType     @relation(fields: [serviceTypeId], references: [id])

  @@unique([mechanicProfileId, serviceTypeId])
}

model Review {
  id        String   @id @default(cuid())
  serviceId String   @unique
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  service ServiceRequest @relation(fields: [serviceId], references: [id])
}

model StatusHistory {
  id              String   @id @default(cuid())
  serviceId       String
  previousStatus  ServiceStatus
  newStatus       ServiceStatus
  changedAt       DateTime @default(now())

  service ServiceRequest @relation(fields: [serviceId], references: [id])

  @@index([serviceId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
